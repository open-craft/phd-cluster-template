name: Update Instance

on:
  workflow_call:
    inputs:
      INSTANCE_NAME:
        description: "Instance to update"
        required: true
        type: string
      CONFIG:
        description: "Config in JSON format to be merged with existing intance config"
        required: true
        type: string
      RUNNER_WORKFLOW_LABEL:
        description: 'The label of the runner workflow to run'
        required: false
        type: string
        default: "ubuntu-latest"
    secrets:
      SSH_PRIVATE_KEY:
        description: "Private SSH key for accessing private repositories"
        required: true

jobs:
  update-instance:
    runs-on: ${{ inputs.RUNNER_WORKFLOW_LABEL }}
    concurrency:
      group: update-instance-${{ inputs.INSTANCE_NAME }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout workflow scripts
        uses: actions/checkout@v4
        with:
          repository: open-craft/phd-cluster-template
          ref: main
          path: workflow-scripts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
          cache: 'pip'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add GitHub to known hosts
        run: ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Update config.yml with provided config
        env:
          CONFIG_FILE: instances/${{ inputs.INSTANCE_NAME }}/config.yml
          SCRIPT_PATH: workflow-scripts/.github/workflows/scripts/update_config.py
        run: |
          python "$SCRIPT_PATH" \
            --config-file "$CONFIG_FILE" \
            --new-config "${{ inputs.CONFIG }}"

      - name: Commit and push changes
        run: |
          git add instances/${{ inputs.INSTANCE_NAME }}

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update config for ${{ inputs.INSTANCE_NAME }}"
            git pull origin ${{ github.ref_name }} --rebase
            git push
          fi
